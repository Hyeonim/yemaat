<html xmlns:th="http://www.thymeleaf.org">

<title th:fragment="titleFragment">맛집 예약, 예맛!</title>

<div th:fragment="headerFragment" id="top">
    <script>
        function sendSearchQuery() {
            const xhr = new XMLHttpRequest();
            xhr.open('GET', '/search?'+getSearchWord(), true);
            xhr.onreadystatechange = function () {
                if (xhr.readyState === 4 && xhr.status === 200) {
                    let doc = new DOMParser().parseFromString(xhr.responseText, 'text/html');
                    let div = document.querySelector('ul#resultList');
                    if ( !div ) return;
                    div.innerHTML = doc.querySelector('ul#resultList').innerHTML;
                    let scriptTags = doc.querySelectorAll('script');
                    let runnableScript = [];
                    scriptTags.forEach(scriptTag => {
                        if (null === scriptTag.getAttribute("map"))
                            return;
                        // eval(scriptTag.textContent);
                        runnableScript.push( scriptTag.textContent );
                    });
                    eval( runnableScript.join( '' ) );
                    var script = Object.assign(document.createElement('script'), { type: 'text/javascript', src: "/js/imglazy.js" });
                    document.head.appendChild(script);
                }
            };
            xhr.send();
        }
    </script>
    <div>
        <nav class="navbar navbar-expand-lg navbar-light" id="allHeader">
<!--            <h2>예약 맛집!</h2>-->
<!--            <div th:replace="~{/include/logo::logoContent(30,1)}"></div>-->
            <div id="mainLogo" th:replace="~{/include/logo::logoContent(30,1)}"></div>

            <div id="navbarNav">




                <form th:action="@{/search}" method="get" >
                    <input id="searchBar" type="search" placeholder="음식 또는 식당명 입력" aria-label="Search" name="keyword" oninput=sendSearchQuery() th:value="${param.keyword}" style="display: none">
                </form>

                <svg class="searIcon" viewBox="0 0 20 20" onclick="toggleSearchForm()">
                    <path d="M18.125,15.804l-4.038-4.037c0.675-1.079,1.012-2.308,1.01-3.534C15.089,4.62,12.199,1.75,8.584,1.75C4.815,1.75,1.982,4.726,2,8.286c0.021,3.577,2.908,6.549,6.578,6.549c1.241,0,2.417-0.347,3.44-0.985l4.032,4.026c0.167,0.166,0.43,0.166,0.596,0l1.479-1.478C18.292,16.234,18.292,15.968,18.125,15.804 M8.578,13.99c-3.198,0-5.716-2.593-5.733-5.71c-0.017-3.084,2.438-5.686,5.74-5.686c3.197,0,5.625,2.493,5.64,5.624C14.242,11.548,11.621,13.99,8.578,13.99 M16.349,16.981l-3.637-3.635c0.131-0.11,0.721-0.695,0.876-0.884l3.642,3.639L16.349,16.981z"></path>
                </svg>



                <button class="alarm-button" onclick="onAlarmClick()">
                    <img src="/images/alarm1.png" alt="alarm1">
                    <p style="display: none;">1</p>
                </button>


                <div>
                    <div style="
                         transform-origin: right top;
                         right: 64px;
                         top: 62px;
                         background-color: #ffffffa0;
                         max-height: 865px;
                         "
                         class="chats dropmenu" name="chat">
                        <div th:include="~{/chat/chatroom::chatFragment}"></div>
                    </div>
                </div>

                <button onclick="onMenuClick()" onblur="handleBlur()">
<!--                <button onclick="onMenuClick()">-->
                    <img id="avatar" src="/images/logo_avatar_32dp.png" alt="avatar" style="width:32px; height:32px; border-radius: 50%;">
                </button>
                <div>
                    <div style="
                         transform-origin: right top;
                         right: 16px;
                         top: 62px;
                         background-color: #ffffffa0;
                         max-height: 865px;
                         "
                    class="dropmenu" name="mymenu">
                        <th:block th:if="${user=='null'}">
                            <ul>
                                <li class="nav-item">
                                    <a class="nav-link" href="/login">로그인</a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link" href="/signUp">회원가입</a>
                                </li>
                            </ul>
                        </th:block>
                        <th:block th:unless="${user=='null'}" th:switch="${user}">
                            <h3 class="nav-item">안녕하세요</h3>
                            <h3 class="nav-item">[[${user_name}]]님</h3>
                            <ul>
                                <th:block th:case="USER">
                                    <li class="nav-item">
                                        <a class="nav-link" href="/user/userPage">마이페이지</a>
                                    </li>
                                </th:block>
                                <th:block th:case="OWNER">
                                    <li class="nav-item">
                                        <a class="nav-link" href="/user/userPage">마이페이지</a>
                                    </li>
                                    <li class="nav-item">
                                        <a class="nav-link" href="/owner/home">가게관리</a>
                                    </li>
                                </th:block>
                                <th:block th:case="ADMIN">
                                    <li class="nav-item">
                                        <a class="nav-link" href="/user/userPage">마이페이지</a>
                                    </li>
                                    <li class="nav-item">
                                        <a class="nav-link" href="/owner/home">가게관리</a>
                                    </li>
                                    <li class="nav-item">
                                        <a class="nav-link" href="/manager/content">관리자페이지</a>
                                    </li>
                                </th:block>
                                <th:block th:default>
                                    <li class="nav-item">
                                        <a class="nav-link" href="/logout">로그아웃</a>
                                    </li>
                                </th:block>

                            </ul>
                        </th:block>
                    </div>
                </div>
            </div>
        </nav>
    </div>
    <script th:inline="javascript">
        (function () {
            if ( [[${user_img}]] )
                document.getElementById("avatar").src = 'data:image/jpeg;base64,' + [[${user_img}]]

        })();
    </script>
    <script>
        function onAlarmClick(btn) {
            document.querySelector("[name=chat]").classList.toggle("visible");
        }

        function onMenuClick(btn) {
            document.querySelector("[name=mymenu]" ).classList.toggle( "visible" );
        }
        async function handleBlur() {
            await sleep(200)
            document.querySelector( "[name=mymenu]" ).classList.remove( "visible" );
        }
        function sleep(ms) { return new Promise(resolve => setTimeout(resolve, ms)); }

        function getSearchWord(){
            const keyword = document.getElementById('searchBar').value;

            const filterString = Array.from(document.querySelectorAll( "ul[class^='filter']" )).map( item=>
                item.className + "=" + Array.from(item.querySelectorAll( ".picked" )).map(e=>e.value).join( "," )
            ).join("&");

            return 'keyword=' + encodeURIComponent(keyword) + "&" + filterString;
        }

        function toggleSearchForm() {
            var form = document.getElementById("searchBar");
            if (form.style.display === "none") {
                form.style.display = "block";
            } else {
                form.style.display = "none";
            }
        }

    </script>
</div>
</html>


